<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Superintendent Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
        }
        h1 {
            color: #1f2937;
            border-bottom: 2px solid #6b7280;
            padding-bottom: 10px;
            margin-bottom: 25px;
            text-align: center;
            font-size: 2rem;
            font-weight: 700;
        }
        #controls {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            gap: 15px;
        }
        .action-button {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        #createUser {
            background-color: #10b981;
            color: white;
        }
        #createUser:hover {
            background-color: #059669;
            transform: translateY(-1px);
        }
        #studentTable {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0 12px;
            margin-top: 10px;
        }
        #studentTable th, #studentTable td {
            padding: 15px;
            text-align: left;
            vertical-align: middle;
        }
        #studentTable thead th {
            background-color: #e5e7eb;
            color: #374151;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        #studentTable tbody tr {
            background-color: #ffffff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            transition: box-shadow 0.2s;
        }
        #studentTable tbody tr:hover {
             box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        .table-btn {
            color: white;
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s;
            margin-right: 5px;
            font-size: 0.875rem;
        }
        .view-btn { background-color: #22c55e; } /* Green */
        .view-btn:hover { background-color: #16a34a; }
        .edit-btn { background-color: #3b82f6; } /* Blue */
        .edit-btn:hover { background-color: #2563eb; }
        .delete-btn { background-color: #ef4444; } /* Red */
        .delete-btn:hover { background-color: #dc2626; }
        .empty-state {
            text-align: center;
            color: #6b7280;
            padding: 40px;
            font-style: italic;
        }

        /* Modal Styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal.open {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background: white;
            padding: 25px;
            border-radius: 10px;
            width: 90%;
            max-width: 550px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }
        .modal.open .modal-content {
            transform: scale(1);
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #374151;
        }
        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            box-sizing: border-box; 
        }

        /* Detail View Modal Specific Styles */
        #studentDetailModal .detail-section { margin-bottom: 1.5rem; }
        #studentDetailModal .detail-heading {
            font-size: 1.125rem;
            font-weight: 600;
            color: #4b5563;
            border-bottom: 1px solid #e5e7eb;
            padding-bottom: 0.5rem;
            margin-bottom: 0.75rem;
        }
        #studentDetailModal p { margin-bottom: 0.5rem; color: #374151; }
        #studentDetailModal p strong {
            color: #1f2937;
            min-width: 120px;
            display: inline-block;
        }

        /* Mobile adjustments */
        @media (max-width: 768px) {
            #studentTable thead { display: none; }
            #studentTable tbody tr {
                display: block;
                margin-bottom: 15px;
                border: 1px solid #e5e7eb;
            }
            #studentTable td {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 10px 15px;
                border-bottom: 1px solid #f3f4f6;
                text-align: right;
            }
            #studentTable td:last-child { border-bottom: none; }
            #studentTable td::before {
                content: attr(data-label);
                font-weight: bold;
                color: #4b5563;
                text-transform: uppercase;
                font-size: 0.8rem;
                text-align: left;
                margin-right: 10px;
            }
        }
    </style>
</head>
<body>

<div class="container">
    <h1><svg class="w-8 h-8 inline-block mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M15 21v-2a6 6 0 00-12 0v2"></path></svg> Student Management</h1>

    <div id="controls">
        <p class="text-gray-700">User: <strong id="superName" class="text-blue-600">Loading...</strong></p>
        <button id="createUser" class="action-button" onclick="openStudentModal()">Create New Student</button> 
    </div>

    <table id="studentTable">
        <thead>
            <tr>
                <th>Username</th>
                <th>Full Name</th>
                <th>Roll No.</th>
                <th>Department</th>
                <th>Year</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="studentTableBody">
            <!-- Student rows are injected here -->
        </tbody>
    </table>
    <p id="loadingMessage" class="empty-state">Loading student data...</p>
</div>

<!-- ========= MODALS ========= -->
<div id="customAlertModal" class="modal">
    <div class="modal-content">
        <h3 id="modalTitle" class="text-lg font-bold mb-3 text-gray-800">Title</h3>
        <p id="modalMessage" class="mb-5 text-gray-600">Message</p>
        <div id="modalButtons" class="flex justify-end space-x-3"></div>
    </div>
</div>

<div id="studentUpsertModal" class="modal">
    <div class="modal-content">
        <h3 id="upsertModalTitle" class="text-lg font-bold mb-5 text-gray-800">Create New Student</h3>
        <form id="studentForm" onsubmit="event.preventDefault(); saveStudent();">
            <input type="hidden" id="formStudentId">
            <div class="form-group"><label for="formUsername">Username</label><input type="text" id="formUsername" required></div>
            <div class="form-group"><label for="formFullName">Full Name</label><input type="text" id="formFullName" required></div>
            <div class="form-group"><label for="formEmail">Email</label><input type="email" id="formEmail" required></div>
            <div class="form-group"><label for="formRoll">Roll Number</label><input type="text" id="formRoll" required></div>
            <div class="form-group"><label for="formDepartment">Department</label><input type="text" id="formDepartment" required></div>
            <div class="form-group"><label for="formYear">Year</label><input type="number" id="formYear" required min="1" max="5"></div>
            <div class="form-group"><label for="formPassword">Password</label><input type="password" id="formPassword"></div>
            <div class="flex justify-end space-x-3 mt-5">
                <button type="button" onclick="closeStudentModal()" class="px-4 py-2 bg-gray-300 text-gray-800 font-semibold rounded-md hover:bg-gray-400 transition">Cancel</button>
                <button type="submit" id="saveButton" class="px-4 py-2 bg-green-600 text-white font-semibold rounded-md hover:bg-green-700 transition">Save Student</button>
            </div>
        </form>
    </div>
</div>

<div id="studentDetailModal" class="modal">
    <div class="modal-content">
        <h3 class="text-xl font-bold mb-5 text-gray-800">Student Profile</h3>
        <div class="detail-section">
            <h4 class="detail-heading">Personal Details</h4>
            <p><strong>Username:</strong> <span id="detailUsername"></span></p>
            <p><strong>Full Name:</strong> <span id="detailFullName"></span></p>
            <p><strong>Roll No:</strong> <span id="detailRoll"></span></p>
            <p><strong>Department:</strong> <span id="detailDepartment"></span></p>
            <p><strong>Year:</strong> <span id="detailYear"></span></p>
        </div>
        <div class="detail-section">
            <h4 class="detail-heading">Meal Preferences</h4>
            <p><strong>Day Meal:</strong> <span id="detailMealDay" class="capitalize"></span></p>
            <p><strong>Night Main:</strong> <span id="detailMealNightMain" class="capitalize"></span></p>
            <p><strong>Night Carb:</strong> <span id="detailMealNightCarb" class="capitalize"></span></p>
            <p><strong>Sunday Day:</strong> <span id="detailMealSundayDay" class="capitalize"></span></p>
            <p><strong>Sunday Night:</strong> <span id="detailMealSundayNight" class="capitalize"></span></p>
        </div>
        <div class="flex justify-end mt-6">
            <button type="button" onclick="closeDetailModal()" class="px-5 py-2 bg-gray-500 text-white font-semibold rounded-md hover:bg-gray-600 transition">Close</button>
        </div>
    </div>
</div>

<script>
    const BACKEND_BASE_URL = "http://localhost:5000"; 
    const SUPERINTENDENT_API_URL = `${BACKEND_BASE_URL}/superintendent`;

    // =========================================================================
    // AUTHENTICATION SERVICE (No changes)
    // =========================================================================
    async function renewAccessToken() {
        const refreshToken = localStorage.getItem('refreshToken');
        if (!refreshToken) { window.location.href = 'login.html'; return null; }
        try {
            const response = await fetch(`${BACKEND_BASE_URL}/auth/refresh`, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${refreshToken}` }
            });
            if (response.ok) {
                const data = await response.json();
                localStorage.setItem('accessToken', data.access);
                return data.access;
            } else {
                window.location.href = 'login.html'; return null;
            }
        } catch (error) { console.error("Token renewal error:", error); return null; }
    }

    async function authenticatedFetch(url, options = {}, retry = true) {
        let accessToken = localStorage.getItem('accessToken');
        if (!accessToken) { window.location.href = 'login.html'; return null; }
        options.headers = { ...options.headers, 'Authorization': `Bearer ${accessToken}` };
        let response = await fetch(url, options);
        if ((response.status === 401 || response.status === 403) && retry) {
            const newAccessToken = await renewAccessToken();
            if (newAccessToken) {
                options.headers['Authorization'] = `Bearer ${newAccessToken}`;
                response = await authenticatedFetch(url, options, false);
            } else { return null; }
        }
        if (!response || response.status === 401 || response.status === 403) {
            if (response) window.location.href = 'login.html';
            return null;
        }
        return response;
    }

    // =========================================================================
    // GENERIC MODAL CONTROLS (No changes)
    // =========================================================================
    const customAlertModal = document.getElementById('customAlertModal');
    const modalTitle = document.getElementById('modalTitle');
    const modalMessage = document.getElementById('modalMessage');
    const modalButtons = document.getElementById('modalButtons');
    function hideModal() { customAlertModal.classList.remove('open'); modalButtons.innerHTML = ''; document.onkeydown = null; }
    function showMessage(title, message) {
        modalTitle.textContent = title;
        modalMessage.textContent = message;
        const okButton = document.createElement('button');
        okButton.textContent = 'OK';
        okButton.className = 'px-4 py-2 bg-blue-600 text-white font-semibold rounded-md hover:bg-blue-700 transition';
        okButton.onclick = hideModal;
        modalButtons.appendChild(okButton);
        customAlertModal.classList.add('open');
    }
    function showConfirmation(title, message) {
        return new Promise(resolve => {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            const okButton = document.createElement('button');
            okButton.textContent = 'Confirm';
            okButton.className = 'px-4 py-2 bg-red-600 text-white font-semibold rounded-md hover:bg-red-700 transition';
            okButton.onclick = () => { hideModal(); resolve(true); };
            const cancelButton = document.createElement('button');
            cancelButton.textContent = 'Cancel';
            cancelButton.className = 'px-4 py-2 bg-gray-300 text-gray-800 font-semibold rounded-md hover:bg-gray-400 transition';
            cancelButton.onclick = () => { hideModal(); resolve(false); };
            modalButtons.appendChild(cancelButton);
            modalButtons.appendChild(okButton);
            customAlertModal.classList.add('open');
            document.onkeydown = (e) => { if (e.key === 'Enter') okButton.click(); };
        });
    }

    // =========================================================================
    // STUDENT MANAGEMENT LOGIC
    // =========================================================================
    const studentUpsertModal = document.getElementById('studentUpsertModal');
    const studentDetailModal = document.getElementById('studentDetailModal');
    const studentForm = document.getElementById('studentForm');
    const upsertModalTitle = document.getElementById('upsertModalTitle');
    const formStudentId = document.getElementById('formStudentId');
    const formUsername = document.getElementById('formUsername');
    const formFullName = document.getElementById('formFullName');
    const formEmail = document.getElementById('formEmail');
    const formRoll = document.getElementById('formRoll');
    const formDepartment = document.getElementById('formDepartment');
    const formYear = document.getElementById('formYear');
    const formPassword = document.getElementById('formPassword');

    function openStudentModal(student = null) {
        studentForm.reset();
        formStudentId.value = '';
        if (student) {
            upsertModalTitle.textContent = `Edit Student: ${student.username}`;
            // FIX: Use 'userId' from your controller's response
            formStudentId.value = student.userId; 
            formUsername.value = student.username;
            formUsername.disabled = true;
            // FIX: Use 'fullName' from your controller's response
            formFullName.value = student.fullName; 
            formEmail.value = student.email || '';
            formRoll.value = student.roll;
            formDepartment.value = student.department;
            formYear.value = student.year;
            formPassword.placeholder = "Leave blank to keep unchanged";
            formPassword.required = false;
        } else {
            upsertModalTitle.textContent = 'Create New Student';
            formUsername.disabled = false;
            formPassword.placeholder = "Enter a password";
            formPassword.required = true;
        }
        studentUpsertModal.classList.add('open');
    }
    
    function closeStudentModal() { studentUpsertModal.classList.remove('open'); }
    
    function openDetailModal(student) {
        document.getElementById('detailUsername').textContent = student.username;
        // FIX: Use 'fullName' from your controller's response
        document.getElementById('detailFullName').textContent = student.fullName; 
        document.getElementById('detailRoll').textContent = student.roll || 'N/A';
        document.getElementById('detailDepartment').textContent = student.department || 'N/A';
        document.getElementById('detailYear').textContent = student.year || 'N/A';
        
        // FIX: Use 'mealPreferences' from your controller's response
        const meals = student.mealPreferences || {}; 
        document.getElementById('detailMealDay').textContent = meals.day || 'Not Set';
        document.getElementById('detailMealNightMain').textContent = meals.night1 || 'Not Set';
        document.getElementById('detailMealNightCarb').textContent = meals.night2 || 'Not Set';
        document.getElementById('detailMealSundayDay').textContent = meals.sunday_day || 'Not Set';
        document.getElementById('detailMealSundayNight').textContent = meals.sunday_night || 'Not Set';
        studentDetailModal.classList.add('open');
    }
    function closeDetailModal() { studentDetailModal.classList.remove('open'); }

    async function saveStudent() {
        const studentId = formStudentId.value;
        const isUpdate = !!studentId;
        
        // FIX: Send 'fullName' (camelCase) to match your controller's 'POST' route
        const studentData = {
            username: formUsername.value,
            fullName: formFullName.value, 
            email: formEmail.value,
            roll: formRoll.value,
            department: formDepartment.value,
            year: parseInt(formYear.value, 10),
        };

        if (formPassword.value) {
            studentData.password = formPassword.value;
        }

        const url = isUpdate ? `${SUPERINTENDENT_API_URL}/users/${studentId}` : `${SUPERINTENDENT_API_URL}/user`;
        const method = isUpdate ? 'PUT' : 'POST';
        
        // On update, send the correct format if your PUT route expects something different
        let body = studentData;
        if(isUpdate) {
            body = {
                // Your PUT route expects full_name, so we translate it
                full_name: studentData.fullName,
                roll: studentData.roll,
                department: studentData.department,
                year: studentData.year,
                ...(studentData.password && { password: studentData.password })
            }
        }

        const response = await authenticatedFetch(url, {
            method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
        });

        if (response && response.ok) {
            showMessage('Success', `Student has been successfully ${isUpdate ? 'updated' : 'created'}.`);
            closeStudentModal();
            fetchAndDisplayStudents();
        } else {
            const error = await response.json();
            showMessage('Error', `Failed to save student: ${error.error || 'Unknown error'}`);
        }
    }

    async function deleteStudent(studentId) {
        const confirmed = await showConfirmation('Delete Student', 'Are you sure you want to permanently delete this student?');
        if (!confirmed) return;
        
        const response = await authenticatedFetch(`${SUPERINTENDENT_API_URL}/user/${studentId}`, { method: 'DELETE' });

        if (response && response.ok) {
            showMessage('Success', 'Student has been deleted.');
            fetchAndDisplayStudents();
        } else {
            const error = await response.json();
            showMessage('Error', `Failed to delete student: ${error.error || 'Unknown error'}`);
        }
    }

    function createStudentTableRow(student) {
        const tr = document.createElement('tr');
        // FIX: Use 'fullName' from your controller's response
        tr.innerHTML = `
            <td data-label="Username">${student.username}</td>
            <td data-label="Full Name">${student.fullName}</td> 
            <td data-label="Roll No.">${student.roll || 'N/A'}</td>
            <td data-label="Department">${student.department || 'N/A'}</td>
            <td data-label="Year">${student.year || 'N/A'}</td>
            <td data-label="Actions">
                <button class="table-btn view-btn">View</button>
                <button class="table-btn edit-btn">Edit</button>
                <button class="table-btn delete-btn">Delete</button>
            </td>
        `;
        tr.querySelector('.view-btn').onclick = () => openDetailModal(student);
        tr.querySelector('.edit-btn').onclick = () => openStudentModal(student);
        // FIX: Use 'userId' from your controller's response for delete
        tr.querySelector('.delete-btn').onclick = () => deleteStudent(student.userId); 
        return tr;
    }

    async function fetchAndDisplayStudents() {
        const tableBody = document.getElementById('studentTableBody');
        const loadingMessage = document.getElementById('loadingMessage');
        tableBody.innerHTML = '';
        loadingMessage.textContent = 'Loading student data...';
        loadingMessage.style.display = 'block';
        
        const response = await authenticatedFetch(SUPERINTENDENT_API_URL);

        if (!response) {
            loadingMessage.textContent = 'Failed to load data. Please log in again.';
            return;
        }
        
        // FIX: The response from your controller is the array directly, not nested in a 'users' object
        const user_data = await response.json(); 

        // Your controller sends the superintendent name separately, let's assume it might come in headers or a different call
        // For now, we'll just check the main data. Your controller sends an object { users: ..., superintendent_name: ... }
        // Let's assume the main response IS that object
        const responseData = user_data;


        if (responseData.users && responseData.users.length > 0) {
            loadingMessage.style.display = 'none';
            responseData.users.forEach(student => {
                const row = createStudentTableRow(student);
                tableBody.appendChild(row);
            });
        } else if (Array.isArray(user_data) && user_data.length > 0) {
            // Fallback if the controller just sends an array
            loadingMessage.style.display = 'none';
            user_data.forEach(student => {
                const row = createStudentTableRow(student);
                tableBody.appendChild(row);
            });
        }
        else {
            loadingMessage.textContent = 'No students found.';
        }
        document.getElementById('superName').textContent = responseData.superintendent_name || 'Superintendent';
    }

    document.addEventListener('DOMContentLoaded', () => {
        fetchAndDisplayStudents();
    });
</script>

</body>
</html>

