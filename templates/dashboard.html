<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #fff7ed;
        }

        .tab-button {
            transition: all 0.2s ease-in-out;
        }

        .tab-button.active {
            color: #f97316;
            border-bottom-color: #f97316;
            font-weight: 600;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 9999px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-pending {
            background-color: #f59e0b;
            color: white;
        }

        .status-approved {
            background-color: #10b981;
            color: white;
        }

        .status-rejected {
            background-color: #ef4444;
            color: white;
        }

        /* Modal Styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .modal.open {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: white;
            padding: 25px;
            border-radius: 10px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }

        /* NEW max-width for notification modal */
        #notificationModal .modal-content {
            max-width: 450px;
        }

        /* END NEW max-width for notification modal */

        .modal.open .modal-content {
            transform: scale(1);
        }

        /* Date Picker Styles */
        #calendar {
            display: block;
            position: absolute;
            border: 1px solid #ccc;
            background: #fff;
            padding: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            border-radius: 8px;
        }

        .calendarMonth {
            text-align: center;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .calendarMonth a {
            text-decoration: none;
            color: #f97316;
            margin: 0 10px;
            cursor: pointer;
        }

        table {
            border-collapse: collapse;
            width: 100%;
        }

        th,
        td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
            width: 14.28%;
        }

        th {
            background-color: #f2f2f2;
            font-weight: bold;
        }

        td a {
            text-decoration: none;
            color: #333;
            display: block;
            padding: 5px;
            cursor: pointer;
        }

        td a:hover {
            background-color: #e9ecef;
        }
    </style>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #fff7ed;
        }

        .tab-button {
            transition: all 0.2s ease-in-out;
        }

        .tab-button.active {
            color: #f97316;
            border-bottom-color: #f97316;
            font-weight: 600;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 9999px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-pending {
            background-color: #f59e0b;
            color: white;
        }

        .status-approved {
            background-color: #10b981;
            color: white;
        }

        .status-rejected {
            background-color: #ef4444;
            color: white;
        }

        /* Modal Styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .modal.open {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: white;
            padding: 25px;
            border-radius: 10px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }

        .modal.open .modal-content {
            transform: scale(1);
        }

        /* --- MODERN DATE/TIME INPUT STYLING --- */
        /* Hides the default calendar icon from date inputs */
        input[type="date"]::-webkit-calendar-picker-indicator,
        input[type="time"]::-webkit-calendar-picker-indicator {
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
            position: absolute;
            left: 0;
            top: 0;
        }

        /* Ensures the inputs look like clean text fields */
        input[type="date"],
        input[type="time"] {
            appearance: none;
            position: relative;
        }

        /* Adds the custom calendar/clock icon inside the inputs */
        .date-time-input-wrapper {
            position: relative;
        }

        .date-time-input-wrapper .icon {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
            /* Icon shouldn't interfere with the picker click area */
            color: #4b5563;
            /* Gray-600 */
        }

        /* ------------------------------------- */
    </style>
</head>

<body class="p-4 sm:p-6">

    <button id="notificationButton" onclick="openNotificationModal()"
        class="fixed top-4 right-4 sm:top-6 sm:right-8 p-2 rounded-full bg-orange-600 text-white hover:bg-orange-700 transition z-50 shadow-lg">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
            class="w-6 h-6">
            <path d="M10 20.25a2 2 0 0 0 4 0" />
            <path
                d="M18 8a6 6 0 0 0-12 0c0 1.28.18 2.51.52 3.59L3 17h18l-1.52-5.41c.34-1.08.52-2.31.52-3.59Z" />
            <path d="M19.7 4.5c.78.78.78 2.05 0 2.83l-1.42 1.42" />
            <path d="M4.3 4.5c-.78.78-.78 2.05 0 2.83l-1.42 1.42" />
        </svg>
        <span id="notificationBadge"
            class="hidden absolute top-0 right-0 inline-flex items-center justify-center p-1 text-xs font-bold leading-none text-red-100 transform translate-x-1/2 -translate-y-1/2 bg-red-600 rounded-full">0</span>
    </button>
    <div class="main-container mx-auto max-w-4xl">

        <div class="bg-white p-6 rounded-xl shadow-lg mb-6">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center">
                <div>
                    <img src="https://upload.wikimedia.org/wikipedia/commons/e/e4/Emblem-Ramakrishna-Mission-Transparent.png"
                        alt="Ramakrishna Mission Vidyamandira Logo" class="mx-auto mb-4 h-20 w-auto sm:mx-0">
                    <h1 class="text-3xl font-extrabold text-gray-800">Student Dashboard</h1>
                    <p class="text-gray-500 mt-1">Manage your weekly meals and leave requests.</p>
                </div>
                <div id="user-profile-info"
                    class="mt-4 sm:mt-0 text-left sm:text-right bg-orange-50 p-4 rounded-lg border flex flex-col items-end">

                    <p class="font-semibold text-gray-600"><strong id="fullName"
                            class="text-orange-600">Loading...</strong></p>
                    <p class="font-semibold text-gray-600" id="userName">...</p>
                    <p class="font-semibold text-gray-600" id="userRoll">Roll: ...</p>
                    <p class="font-semibold text-gray-600" id="userDept">Department: ...</p>
                    <p class="font-semibold text-gray-600" id="userYear">Year: ...</p>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-lg p-2 mb-6">
            <nav class="flex space-x-2" aria-label="Tabs">
                <button
                    class="tab-button active flex-1 text-center py-3 px-4 border-b-2 border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700"
                    data-tab="meals">
                    üç≤ Meal Selector
                </button>
                <button
                    class="tab-button flex-1 text-center py-3 px-4 border-b-2 border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700"
                    data-tab="leaves">
                    ‚úàÔ∏è Leave Application
                </button>
            </nav>
        </div>

        <div>
            <div id="meals" class="tab-content active space-y-6">
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h2 class="text-xl font-bold text-gray-700 mb-4">üçΩÔ∏è Weekday Day Meal (Mon - Sat)</h2>
                    <select id="weekday-day-main"
                        class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500">
                        <option value="" disabled selected>-- Select Main Dish --</option>
                        <option value="fish">üêü Fish</option>
                        <option value="curd">ü•õ Curd</option>
                    </select>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h2 class="text-xl font-bold text-gray-700 mb-4">üåô Weekday Night Meal (Mon - Sat)</h2>
                    <div class="space-y-4">
                        <select id="weekday-night-main"
                            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500">
                            <option value="" disabled selected>-- Select Main Dish --</option>
                            <option value="veg">ü•¨ Veg</option>
                            <option value="egg">ü•ö Egg</option>
                        </select>
                        <select id="weekday-night-carb"
                            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500">
                            <option value="" disabled selected>-- Select Carb/Starch --</option>
                            <option value="roti">ü´ì Roti</option>
                            <option value="rice">üçö Rice</option>
                        </select>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h2 class="text-xl font-bold text-gray-700 mb-4">‚òÄÔ∏è Sunday Special</h2>
                    <div class="space-y-4">
                        <select id="sunday-day"
                            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500">
                            <option value="" disabled selected>-- Select Day Main --</option>
                            <option value="meat">üçó Meat</option>
                            <option value="fish">üêü Fish</option>
                            <option value="paneer">üßÄ Paneer</option>
                        </select>
                        <select id="sunday-night"
                            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500">
                            <option value="" disabled selected>-- Select Night Main --</option>
                            <option value="veg">ü•¨ Veg</option>
                        </select>
                    </div>
                </div>
                <div class="text-center mt-6">
                    <button onclick="submitMealSelections()"
                        class="w-full sm:w-auto bg-orange-600 hover:bg-orange-700 text-white font-bold py-3 px-8 rounded-lg shadow-md transition duration-300 transform hover:scale-105">Save
                        Meal Choices</button>
                </div>
            </div>

            <div id="leaves" class="tab-content space-y-6">
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h2 class="text-xl font-bold text-gray-700 mb-4">üìù Apply for Leave</h2>
                    <form id="leaveForm" class="space-y-6">

                        <div class="p-4 rounded-lg border border-red-200 bg-red-50">
                            <h3 class="text-lg font-semibold text-red-700 mb-3 flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                    stroke-width="1.5" stroke="currentColor" class="w-6 h-6 mr-2">
                                    <path stroke-linecap="round" stroke-linejoin="round"
                                        d="M15.75 9V5.25A2.25 2.25 0 0013.5 3h-6a2.25 2.25 0 00-2.25 2.25v13.5A2.25 2.25 0 007.5 21h6a2.25 2.25 0 002.25-2.25V15M15.75 9l-3 3m0 0l-3-3m3 3V5.25" />
                                </svg>
                                Departure Details
                            </h3>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <div class="date-time-input-wrapper">
                                    <label for="departure-date"
                                        class="block text-xs font-medium text-gray-600 mb-1">Date</label>
                                    <input type="text" id="departure-date" required placeholder="YYYY-MM-DD"
                                        onfocus="showDatePicker(this)" onkeydown="return false;"
                                        class="w-full p-3 pr-10 border border-gray-300 rounded-lg shadow-sm focus:ring-orange-500 focus:border-orange-500 appearance-none bg-white">
                                    <svg class="icon h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                    </svg>
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-600 mb-1">Time</label>
                                    <div class="flex space-x-2">
                                        <select id="departure-hour" required
                                            class="flex-1 p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-orange-500 focus:border-orange-500">
                                            <option value="">HH</option>
                                            <script>for (let i = 0; i < 24; i++) { document.write(`<option value="${i.toString().padStart(2, '0')}">${i.toString().padStart(2, '0')}</option>`); }</script>
                                        </select>
                                        <span class="self-center text-gray-500">:</span>
                                        <select id="departure-minute" required
                                            class="flex-1 p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-orange-500 focus:border-orange-500">
                                            <option value="">MM</option>
                                            <script>for (let i = 0; i < 60; i += 5) { document.write(`<option value="${i.toString().padStart(2, '0')}">${i.toString().padStart(2, '0')}</option>`); }</script>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="p-4 rounded-lg border border-green-200 bg-green-50">
                            <h3 class="text-lg font-semibold text-green-700 mb-3 flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                    stroke-width="1.5" stroke="currentColor" class="w-6 h-6 mr-2">
                                    <path stroke-linecap="round" stroke-linejoin="round"
                                        d="M8.25 7.5V11.25m0-3.75h3.75M15.75 12V7.5a2.25 2.25 0 00-2.25-2.25H12a2.25 2.25 0 00-2.25 2.25M15.75 12V16.5a2.25 2.25 0 01-2.25 2.25H12a2.25 2.25 0 01-2.25-2.25m0-4.5h3.75m-3.75 0h-1.5M10.5 15h3.75M12 21.75c-4.97 0-9-4.03-9-9s4.03-9 9-9 9 4.03 9 9-4.03 9-9 9z" />
                                </svg>
                                Arrival Details
                            </h3>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <div class="date-time-input-wrapper">
                                    <label for="arrival-date"
                                        class="block text-xs font-medium text-gray-600 mb-1">Date</label>
                                    <input type="text" id="arrival-date" required placeholder="YYYY-MM-DD"
                                        onfocus="showDatePicker(this)" onkeydown="return false;"
                                        class="w-full p-3 pr-10 border border-gray-300 rounded-lg shadow-sm focus:ring-orange-500 focus:border-orange-500 appearance-none bg-white">
                                    <svg class="icon h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                    </svg>
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-600 mb-1">Time</label>
                                    <div class="flex space-x-2">
                                        <select id="arrival-hour" required
                                            class="flex-1 p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-orange-500 focus:border-orange-500">
                                            <option value="">HH</option>
                                            <script>for (let i = 0; i < 24; i++) { document.write(`<option value="${i.toString().padStart(2, '0')}">${i.toString().padStart(2, '0')}</option>`); }</script>
                                        </select>
                                        <span class="self-center text-gray-500">:</span>
                                        <select id="arrival-minute" required
                                            class="flex-1 p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-orange-500 focus:border-orange-500">
                                            <option value="">MM</option>
                                            <script>for (let i = 0; i < 60; i += 5) { document.write(`<option value="${i.toString().padStart(2, '0')}">${i.toString().padStart(2, '0')}</option>`); }</script>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-3">Meal Options:</label>
                            <div class="grid grid-cols-2 sm:grid-cols-4 gap-4">
                                <div
                                    class="bg-gray-100 p-3 rounded-lg flex items-center border border-gray-200 hover:bg-gray-200 transition">
                                    <input id="cancel-lunch-before" type="checkbox"
                                        class="h-5 w-5 text-orange-600 border-gray-300 rounded focus:ring-orange-500">
                                    <label for="cancel-lunch-before"
                                        class="ml-2 text-sm font-medium text-gray-700 select-none">Lunch Before</label>
                                </div>
                                <div
                                    class="bg-gray-100 p-3 rounded-lg flex items-center border border-gray-200 hover:bg-gray-200 transition">
                                    <input id="cancel-dinner-before" type="checkbox"
                                        class="h-5 w-5 text-orange-600 border-gray-300 rounded focus:ring-orange-500">
                                    <label for="cancel-dinner-before"
                                        class="ml-2 text-sm font-medium text-gray-700 select-none">Dinner Before</label>
                                </div>
                                <div
                                    class="bg-gray-100 p-3 rounded-lg flex items-center border border-gray-200 hover:bg-gray-200 transition">
                                    <input id="cancel-lunch-after" type="checkbox"
                                        class="h-5 w-5 text-orange-600 border-gray-300 rounded focus:ring-orange-500">
                                    <label for="cancel-lunch-after"
                                        class="ml-2 text-sm font-medium text-gray-700 select-none">Lunch After</label>
                                </div>
                                <div
                                    class="bg-gray-100 p-3 rounded-lg flex items-center border border-gray-200 hover:bg-gray-200 transition">
                                    <input id="cancel-dinner-after" type="checkbox"
                                        class="h-5 w-5 text-orange-600 border-gray-300 rounded focus:ring-orange-500">
                                    <label for="cancel-dinner-after"
                                        class="ml-2 text-sm font-medium text-gray-700 select-none">Dinner After</label>
                                </div>
                            </div>
                        </div>

                        <div>
                            <label for="leave-reason" class="block text-sm font-bold text-gray-700 mb-1">Reason for
                                Leave</label>
                            <textarea id="leave-reason" rows="3" required
                                class="mt-1 block w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-orange-500 focus:border-orange-500"
                                placeholder="e.g., Family function, medical appointment..."></textarea>
                        </div>

                        <div class="text-right pt-2">
                            <button type="submit"
                                class="w-full sm:w-auto bg-orange-600 hover:bg-orange-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition duration-300 transform hover:scale-105">Submit
                                Request</button>
                        </div>
                    </form>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h2 class="text-xl font-bold text-gray-700 mb-4">Status of Your Requests</h2>
                    <div id="leave-history" class="space-y-3">
                        <p id="leave-history-loading" class="text-gray-500 text-center">Loading leave history...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="customAlertModal" class="modal">
        <div class="modal-content">
            <h3 id="modalTitle" class="text-xl font-bold mb-3 text-gray-800">Notification</h3>
            <p id="modalMessage" class="mb-5 text-gray-600">Message</p>
            <div class="flex justify-end">
                <button
                    class="px-4 py-2 bg-orange-600 text-white font-semibold rounded-md hover:bg-orange-700 transition"
                    onclick="hideModal()">OK</button>
            </div>
        </div>
    </div>

    <div id="notificationModal" class="modal">
        <div class="modal-content">
            <h3 class="text-xl font-bold mb-5 text-gray-800 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                    class="w-6 h-6 mr-2 text-orange-600">
                    <path d="M10 20.25a2 2 0 0 0 4 0" />
                    <path d="M18 8a6 6 0 0 0-12 0c0 1.28.18 2.51.52 3.59L3 17h18l-1.52-5.41c.34-1.08.52-2.31.52-3.59Z" />
                    <path d="M19.7 4.5c.78.78.78 2.05 0 2.83l-1.42 1.42" />
                    <path d="M4.3 4.5c-.78.78-.78 2.05 0 2.83l-1.42 1.42" />
                </svg>
                Request Statuses
            </h3>
            <div id="notificationContent" class="space-y-4">
                <p class="text-gray-500 text-center" id="notificationLoading">Loading statuses...</p>
            </div>
            <div class="flex justify-end mt-6">
                <button class="px-4 py-2 bg-gray-500 text-white font-semibold rounded-md hover:bg-gray-600 transition"
                    onclick="closeNotificationModal()">Close</button>
            </div>
        </div>
    </div>
    <script>
        const BACKEND_BASE_URL = "http://localhost:5000";

        // ===================================
        // --- COMPLETE AUTHENTICATION SERVICE (NO CHANGE) ---
        // ===================================
        async function renewAccessToken() {
            const accessToken = localStorage.getItem('accessToken');
            if (!accessToken) {
                window.location.href = 'login.html';
                return null;
            }

            try {
                const response = await fetch(`${BACKEND_BASE_URL}/auth/refresh`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    localStorage.setItem('accessToken', data.access);
                    return data.access;
                } else {
                    window.location.href = 'login.html';
                    return null;
                }
            } catch (error) {
                return null;
            }
        }

        async function authenticatedFetch(url, options = {}, retry = true) {
            let accessToken = localStorage.getItem('accessToken');

            if (!accessToken) {
                window.location.href = 'login.html';
                return null;
            }

            options.headers = {
                ...options.headers,
                'Authorization': `Bearer ${accessToken}`
            };

            let response = await fetch(url, options);

            if ((response.status === 401 || response.status === 403) && retry) {
                const newAccessToken = await renewAccessToken();

                if (newAccessToken) {
                    options.headers['Authorization'] = `Bearer ${newAccessToken}`;
                    response = await authenticatedFetch(url, options, false);
                } else {
                    return null;
                }
            }

            return response;
        }

        // --- Ensure authentication on load ---
        if (!localStorage.getItem('accessToken')) {
            window.location.href = 'login.html';
        }

        // --- MODAL FUNCTIONS (SLIGHTLY MODIFIED) ---
        const modal = document.getElementById('customAlertModal');
        const notificationModal = document.getElementById('notificationModal');
        const notificationContent = document.getElementById('notificationContent');
        const notificationBadge = document.getElementById('notificationBadge');

        function hideModal() { modal.classList.remove('open'); }
        function showMessage(title, message) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalMessage').textContent = message;
            modal.classList.add('open');
        }

        // NEW Notification Modal functions
        function openNotificationModal() {
            notificationModal.classList.add('open');
            // Refetch data when opening to ensure it's up to date
            updateNotificationStatus();
        }

        function closeNotificationModal() {
            notificationModal.classList.remove('open');
        }
        // END NEW Notification Modal functions

        // --- TAB SWITCHING LOGIC (NO CHANGE) ---
        const tabs = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                tabs.forEach(item => item.classList.remove('active'));
                tab.classList.add('active');
                const target = document.getElementById(tab.dataset.tab);
                tabContents.forEach(content => content.classList.remove('active'));
                target.classList.add('active');

                if (tab.dataset.tab === 'leaves') {
                    fetchLeaveHistory();
                }
            });
        });

        // --- MEAL SELECTION LOGIC (NO CHANGE) ---
        const MEAL_FIELDS = { 'weekday-day-main': 'day', 'weekday-night-main': 'night1', 'weekday-night-carb': 'night2', 'sunday-day': 'sunday_day', 'sunday-night': 'sunday_night' };
        async function submitMealSelections() {
            // NOTE: The keys here must match the keys the backend is expecting from req.body 
            const selections = {
                weekdayDayMain: document.getElementById('weekday-day-main').value,
                weekdayNightMain: document.getElementById('weekday-night-main').value,
                weekdayNightCarb: document.getElementById('weekday-night-carb').value,
                sundayDayMain: document.getElementById('sunday-day').value,
                sundayNightMain: document.getElementById('sunday-night').value
            };

            for (const key in selections) {
                if (!selections[key]) {
                    showMessage("Missing Selection", "Please make a selection for ALL meal options.");
                    return;
                }
            }

            try {
                const response = await authenticatedFetch(`${BACKEND_BASE_URL}/meal`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(selections) // Sending the data with camelCase keys
                });

                if (!response) return;

                if (response.ok) {
                    showMessage('Success! üéâ', 'Meal change request submitted. Please check the notifications for status.');
                    updateNotificationStatus(); // Update badge after submission
                } else {
                    const errorData = await response.json();
                    const errorMessage = errorData.error || response.statusText;

                    if (errorMessage.includes("Max limit reached")) {
                        showMessage('Limit Reached üõë', errorMessage + " Please select an alternative option.");
                    } else {
                        showMessage("Error", errorMessage || "Failed to submit meal change request.");
                    }
                }
            } catch (error) {
                showMessage("Network Error", "Could not connect to the server.");
            }
        }

        // --- LEAVE APPLICATION LOGIC (MODIFIED FOR REUSABLE HISTORY FETCH) ---
        const leaveForm = document.getElementById('leaveForm');
        leaveForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            await submitLeaveRequest();
        });

        async function submitLeaveRequest() {
            // Get date from text input
            const fullNameElement = document.getElementById('fullName');
            const usernameElement = document.getElementById('userName');
            const fullName = fullNameElement ? fullNameElement.textContent.replace('Fullname: ', '').trim() : '';
            const username = usernameElement ? usernameElement.textContent.replace('username: ', '').trim() : '';
            const departureDate = document.getElementById('departure-date').value;
            const arrivalDate = document.getElementById('arrival-date').value;

            // Get time from selects
            const departureHour = document.getElementById('departure-hour').value;
            const departureMinute = document.getElementById('departure-minute').value;
            const arrivalHour = document.getElementById('arrival-hour').value;
            const arrivalMinute = document.getElementById('arrival-minute').value;

            const departureTime = `${departureHour}:${departureMinute}`;
            const arrivalTime = `${arrivalHour}:${arrivalMinute}`;

            // Concatenate Date and Time (Assuming backend expects ISO-like format)
            const departureDateTime = `${departureDate}T${departureTime}:00`;
            const arrivalDateTime = `${arrivalDate}T${arrivalTime}:00`;

            const reason = document.getElementById('leave-reason').value;

            // Meal Checkboxes
            const cancelLunchBefore = document.getElementById('cancel-lunch-before').checked;
            const cancelDinnerBefore = document.getElementById('cancel-dinner-before').checked;
            const cancelLunchAfter = document.getElementById('cancel-lunch-after').checked;
            const cancelDinnerAfter = document.getElementById('cancel-dinner-after').checked;

            // Basic validation
            if (!departureDate || !departureHour || !departureMinute || !arrivalDate || !arrivalHour || !arrivalMinute) {
                showMessage("Missing Fields", "Please fill all date and time fields.");
                return;
            }

            if (new Date(arrivalDateTime) < new Date(departureDateTime)) {
                showMessage("Invalid Dates", "Arrival date/time cannot be before the departure date/time.");
                return;
            }

            try {
                const response = await authenticatedFetch(`${BACKEND_BASE_URL}/leave`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username: username,
                        fullName: fullName,
                        departure: departureDateTime,
                        arrival: arrivalDateTime,
                        reason: reason,
                        cancelLunchBefore: cancelLunchBefore,
                        cancelDinnerBefore: cancelDinnerBefore,
                        cancelLunchAfter: cancelLunchAfter,
                        cancelDinnerAfter: cancelDinnerAfter
                    })
                });

                if (!response) return;

                if (response.ok) {
                    showMessage('Success', 'Leave request submitted successfully. Please check the notifications for status.');
                    leaveForm.reset();
                    fetchLeaveHistory(); // Refresh the history tab
                    updateNotificationStatus(); // Update badge
                } else {
                    const errorData = await response.json();
                    showMessage("Submission Error", errorData.error || "Failed to submit leave request.");
                }
            } catch (error) {
                showMessage("Network Error", "Could not submit your request.");
            }
        }

        // Modified to be reusable for notifications
        async function fetchLeaveHistory(renderToTab = true) {
            const historyContainer = document.getElementById('leave-history');
            try {
                if (renderToTab) {
                    historyContainer.innerHTML = `<p id="leave-history-loading" class="text-gray-500 text-center">Loading leave history...</p>`;
                }
                const response = await authenticatedFetch(`${BACKEND_BASE_URL}/leave/history`);
                if (!response) {
                    if (renderToTab) historyContainer.innerHTML = '<p class="text-red-500 text-center">Could not load history.</p>';
                    return [];
                }
                const history = await response.json();

                if (renderToTab) {
                    historyContainer.innerHTML = '';
                    if (history.length === 0) {
                        historyContainer.innerHTML = `<p class="text-gray-500 text-center">You have not applied for any leave yet.</p>`;
                    } else {
                        history.forEach(leave => {
                            const statusClass = `status-${leave.status.toLowerCase()}`;
                            const card = document.createElement('div');
                            card.className = 'border rounded-lg p-4 flex justify-between items-center bg-orange-50 hover:shadow-md transition';
                            card.innerHTML = `
                                <div>
                                    <p class="font-semibold text-gray-800">From: ${leave.from.substring(0, 10)} To: ${leave.to.substring(0, 10)}</p>
                                    <p class="text-sm text-gray-600">${leave.reason}</p>
                                </div>
                                <span class="status-badge ${statusClass}">${leave.status}</span>
                            `;
                            historyContainer.appendChild(card);
                        });
                    }
                }
                // Return history for use in notification function
                return history;

            } catch (error) {
                if (renderToTab) historyContainer.innerHTML = `<p class="text-red-500 text-center">Failed to load leave history.</p>`;
                return [];
            }
        }


        // --- NEW MEAL REQUEST HISTORY FETCH ---
        async function fetchMealRequestHistory() {
            try {
                // Using the new endpoint /meal/history
                const response = await authenticatedFetch(`${BACKEND_BASE_URL}/meal/history`);
                if (!response) return [];
                const history = await response.json();
                return history;
            } catch (error) {
                console.error("Failed to fetch meal request history:", error);
                return [];
            }
        }

        // --- CONSOLIDATED STATUS UPDATE / NOTIFICATION LOGIC ---
        async function updateNotificationStatus() {
            notificationContent.innerHTML = `<p class="text-gray-500 text-center" id="notificationLoading">Loading statuses...</p>`;

            // Fetch histories without rendering to the tabs
            const [leaveHistory, mealHistory] = await Promise.all([
                fetchLeaveHistory(false),
                fetchMealRequestHistory()
            ]);

            notificationContent.innerHTML = '';
            let unreadCount = 0;

            // 1. Leave Status
            if (leaveHistory.length > 0) {
                const latestLeave = leaveHistory[0]; // Assuming history is returned newest first
                const status = latestLeave.status.toLowerCase();
                const statusClass = `status-${status}`;
                const leaveCard = document.createElement('div');
                leaveCard.className = 'border rounded-lg p-4 bg-gray-50';
                leaveCard.innerHTML = `
                    <p class="font-bold text-gray-800 mb-1 flex justify-between items-center">
                        <span class="flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4 mr-2 text-red-500">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M11.25 11.25l.041-.02a.75.75 0 01.92 0m-.92 0a.75.75 0 00.92 0M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9 3a.75.75 0 00.75-.75V9.75M12 9h.008v.008H12V9z" />
                            </svg>
                            Leave Request 
                        </span>
                        <span class="status-badge ${statusClass}">${latestLeave.status}</span>
                    </p>
                    <p class="text-sm text-gray-600">Latest request: ${latestLeave.from.substring(0, 10)} to ${latestLeave.to.substring(0, 10)}</p>
                `;
                notificationContent.appendChild(leaveCard);
                if (status === 'pending') unreadCount++;
            }

            // 2. Meal Change Status
            if (mealHistory.length > 0) {
                const latestMeal = mealHistory[0];
                const status = latestMeal.status.toLowerCase();
                const statusClass = `status-${status}`;
                const mealCard = document.createElement('div');
                mealCard.className = 'border rounded-lg p-4 bg-gray-50';
                mealCard.innerHTML = `
                    <p class="font-bold text-gray-800 mb-1 flex justify-between items-center">
                        <span class="flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4 mr-2 text-orange-500">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v1.5m0 15V21m9-9h-1.5M4.5 12H3m18 0a9 9 0 11-18 0 9 9 0 0118 0zm-7.5-6h-3M15 15.75h-3M9 12h.008v.008H9V12zm3 0h.008v.008H12V12z" />
                            </svg>
                            Meal Change Request
                        </span>
                        <span class="status-badge ${statusClass}">${latestMeal.status}</span>
                    </p>
                    <p class="text-sm text-gray-600">Status for new choices: Day: ${latestMeal.day}, Night: ${latestMeal.night1}/${latestMeal.night2}</p>
                `;
                notificationContent.appendChild(mealCard);
                if (status === 'pending') unreadCount++;
            }

            if (leaveHistory.length === 0 && mealHistory.length === 0) {
                notificationContent.innerHTML = `<p class="text-gray-500 text-center">No pending requests found.</p>`;
            }

            // Update badge count
            if (unreadCount > 0) {
                notificationBadge.textContent = unreadCount;
                notificationBadge.classList.remove('hidden');
            } else {
                notificationBadge.classList.add('hidden');
            }
        }


        // --- INITIAL DATA LOAD ---
        async function fetchInitialData() {
            try {
                const response = await authenticatedFetch(`${BACKEND_BASE_URL}/user-details`);
                if (!response) return;

                if (response.ok) {
                    const data = await response.json();

                    // Populating all user profile details
                    document.getElementById('userName').textContent = `username: ${data.username || 'N/A'}`;
                    document.getElementById('fullName').textContent = `Fullname: ${data.fullName || 'N/A'}`;
                    document.getElementById('userRoll').textContent = `Roll: ${data.roll || 'N/A'}`;
                    document.getElementById('userDept').textContent = `Department: ${data.department || 'N/A'}`;
                    document.getElementById('userYear').textContent = `Year: ${data.year || 'N/A'}`;


                    // Populate Meal Selections
                    const meals = data.mealPreferences;
                    if (meals) {
                        const mealMap = {
                            'day': 'weekday-day-main',
                            'night1': 'weekday-night-main',
                            'night2': 'weekday-night-carb',
                            'sunday_day': 'sunday-day',
                            'sunday_night': 'sunday-night'
                        };

                        for (const dbFieldName in mealMap) {
                            const elementId = mealMap[dbFieldName];
                            const selectElement = document.getElementById(elementId);

                            if (meals[dbFieldName] && selectElement) {
                                selectElement.value = meals[dbFieldName];
                            }
                        }
                    }
                } else {
                    showMessage("Error", "Failed to load your profile data.");
                }
            } catch (error) {
                showMessage("Network Error", "Could not connect to the server.");
            }
        }

        // --- CUSTOM DATE PICKER FUNCTIONS ---
        var monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];

        function selectDate(dateInputId, year, month, day) {
            var dateInput = document.getElementById(dateInputId);
            if (dateInput) {
                dateInput.value = year + "-" + ((month < 10) ? "0" : "") + month + "-" + ((day < 10) ? "0" : "") + day;
            }
            removeCalendar();
            return false;
        }

        function showMonth(calendarDestId, dateInputId, month, year) {
            var target = document.getElementById(calendarDestId);
            var month = month != null ? month : new Date().getMonth();
            var year = year || new Date().getFullYear();
            var firstOfMonth = new Date();
            firstOfMonth.setFullYear(year);
            firstOfMonth.setMonth(month);
            firstOfMonth.setDate(1);
            var lastOfMonth = new Date();
            lastOfMonth.setDate(1);
            lastOfMonth.setFullYear(year);
            lastOfMonth.setMonth(month + 1);
            lastOfMonth.setDate(lastOfMonth.getDate() - 1);
            var previousYear = year;
            var nextYear = year;
            var previousMonth = month - 1;
            var nextMonth = month + 1;
            if (previousMonth < 0) {
                previousYear -= 1;
                previousMonth = 11;
            }
            if (nextMonth > 11) {
                nextYear += 1;
                nextMonth = 0;
            }
            var tbl = "<div class='calendarMonth'><a href='#inv' onclick='return showMonth(\"" + calendarDestId + "\", \"" + dateInputId + "\", " + previousMonth + ", " + previousYear + ");'>&lt;&lt;</a>" +
                " " + monthNames[month] + " " + year + " " +
                "<a href='#inv' onclick='return showMonth(\"" + calendarDestId + "\", \"" + dateInputId + "\", " + nextMonth + ", " + nextYear + ");'>&gt;&gt;</a></div>" +
                "<table>" +
                "<tr><th>Sun</th><th>Mon</th><th>Tue</th><th>Wed</th><th>Thu</th><th>Fri</th><th>Sat</th></tr>" +
                "<tr>";
            var dow = firstOfMonth.getDay();
            for (var i = 0; i < firstOfMonth.getDay(); i++) {
                tbl += "<td></td>";
            }
            for (var day = 1; day <= lastOfMonth.getDate(); day++) {
                if (dow == 7) {
                    tbl += "</tr><tr>";
                    dow = 0;
                }
                tbl += "<td><a href='#inv' onclick='return selectDate(\"" + dateInputId + "\", " + year + ", " + (month + 1) + ", " + day + ");'>" + day + "</a></td>";
                dow++;
            }
            tbl += "</tr></table>";
            target.innerHTML = tbl;
        }

        function dismissCalendar(event) {
            var cal = document.getElementById("calendar");
            if (cal) {
                if (event.target == cal.targetId) {
                    return;
                }
                var elem = event.target;
                while (elem) {
                    if (elem.id == "calendar") {
                        return;
                    }
                    elem = elem.parentElement;
                }
                cal.parentElement.removeChild(cal);
                document.removeEventListener("mousedown", dismissCalendar);
            }
        }

        function showDatePicker(target) {
            var currentCalendar = document.getElementById("calendar");
            if (currentCalendar) {
                if (currentCalendar.targetId && currentCalendar.targetId == target.id) {
                    return;
                } else {
                    removeCalendar();
                }
            }

            var selectedMonth = null;
            var selectedYear = null;

            var dateSelectedStr = target.value;
            if (dateSelectedStr) {
                var dateSelected = new Date();
                if (dateSelectedStr != "") {
                    var components = dateSelectedStr.split("-");
                    dateSelected.setFullYear(components[0]);
                    dateSelected.setMonth(components[1] - 1);
                    dateSelected.setDate(components[2]);
                }
                selectedMonth = dateSelected.getMonth();
                selectedYear = dateSelected.getFullYear();
            }

            var calendarDiv = document.createElement("div");
            calendarDiv.id = "calendar";
            calendarDiv.style.display = "block";
            calendarDiv.style.position = "absolute";
            var leftOffset = 0;
            var topOffset = 0;
            var elem = target;
            while (elem != null) {
                leftOffset += elem.offsetLeft;
                topOffset += elem.offsetTop;
                elem = elem.offsetParent;
            }
            calendarDiv.style.left = leftOffset + "px";
            calendarDiv.style.top = (topOffset + target.offsetHeight) + "px";
            calendarDiv.style.border = "1px solid";
            calendarDiv.style.background = "#fff";
            calendarDiv.targetId = target.id;
            document.body.appendChild(calendarDiv);
            showMonth("calendar", target.id, selectedMonth, selectedYear);
            document.addEventListener("mousedown", dismissCalendar);
        }

        function removeCalendar() {
            var calendarDiv = document.getElementById("calendar");
            if (calendarDiv) {
                calendarDiv.parentElement.removeChild(calendarDiv);
            }
            document.removeEventListener("mousedown", dismissCalendar);
        }

        document.addEventListener('DOMContentLoaded', () => {
            fetchInitialData();
            fetchLeaveHistory();
            updateNotificationStatus(); // Initial check for notifications
            // Set an interval to refresh the notifications periodically
            setInterval(updateNotificationStatus, 60000); // refresh every minute
        });
    </script>

</body>

</html>
